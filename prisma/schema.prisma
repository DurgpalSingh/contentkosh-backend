generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           Int        @id @default(autoincrement())
  businessId   Int?       @map("business_id")
  name         String
  email        String
  mobile       String?
  password     String     @map("password_hash")
  role         UserRole   @default(USER)
  status       UserStatus @default(ACTIVE)
  emailVerified Boolean   @default(false) @map("email_verified")
  
  createdBy    Int?       @map("created_by")
  updatedBy    Int?       @map("updated_by")
  createdAt    DateTime   @default(now()) @map("created_at")
  updatedAt    DateTime   @default(now()) @updatedAt @map("updated_at")

  // Relations
  business      Business?  @relation(fields: [businessId], references: [id], onDelete: Cascade)
  createdExams  Exam[]     @relation("CreatedExams")
  updatedExams  Exam[]     @relation("UpdatedExams")
  batchUsers    BatchUser[]
  rolePermissions RolePermission[]
  refreshTokens RefreshToken[]
  contentUploads Content[] @relation("ContentUploader")
  contentUpdates Content[] @relation("ContentUpdater")
  teacher       Teacher?
  createdTeachers Teacher[] @relation("TeacherCreatedBy")
  updatedTeachers Teacher[] @relation("TeacherUpdatedBy")

  @@unique([businessId, email])
  @@unique([businessId, mobile])
  @@index([businessId])
  @@index([businessId, role])
  @@index([businessId, status])
  @@map("users")
}

model RefreshToken {
  id        Int      @id @default(autoincrement())
  token     String   @unique
  userId    Int      @map("user_id")
  expiresAt DateTime @map("expires_at")
  isRevoked Boolean  @default(false) @map("is_revoked")
  createdAt DateTime @default(now()) @map("created_at")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("refresh_tokens")
}

model Business {
  id            Int      @id @default(autoincrement())
  instituteName String   @map("institute_name")
  slug          String?  @unique
  logo          String?  // URL or file path to logo
  tagline       String?
  contactNumber String?        @map("contact_number")
  email         String?
  address       String?
  youtubeUrl    String?        @map("youtube_url")
  instagramUrl  String?        @map("instagram_url")
  linkedinUrl   String?        @map("linkedin_url")
  facebookUrl   String?        @map("facebook_url")
  createdAt     DateTime       @default(now()) @map("created_at")
  updatedAt     DateTime       @updatedAt @map("updated_at")
  isDeleted     Boolean        @default(false) @map("is_deleted")
  announcements Announcement[]
  exams         Exam[]
  users         User[]
  teachers      Teacher[]

  @@map("business")
}

model Batch {
  id          Int      @id @default(autoincrement())
  codeName    String   @unique @map("code_name")
  displayName String   @map("display_name")
  startDate   DateTime @map("start_date")
  endDate     DateTime @map("end_date")
  isActive    Boolean  @default(true) @map("is_active")
  courseId    Int      @map("course_id")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  course     Course @relation(fields: [courseId], references: [id], onDelete: Cascade)
  batchUsers BatchUser[]
  contents   Content[]

  @@index([courseId])
  @@map("batches")
}

model BatchUser {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  batchId   Int      @map("batch_id")
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")
  batch     Batch    @relation(fields: [batchId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, batchId])
  @@map("batch_users")
}

model Announcement {
  id          Int      @id @default(autoincrement())
  heading     String
  content     String
  startDate   DateTime @map("start_date")
  endDate     DateTime @map("end_date")
  isActive    Boolean  @default(true) @map("is_active")
  businessId  Int      @map("business_id")
  visibleToAdmins    Boolean @default(false) @map("visible_to_admins")
  visibleToTeachers  Boolean @default(false) @map("visible_to_teachers")
  visibleToStudents  Boolean @default(false) @map("visible_to_students")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([businessId])
  @@map("announcements")
}

model Exam {
  id            Int        @id @default(autoincrement())
  name          String
  code          String?
  description   String?
  status        ExamStatus @default(ACTIVE)
  startDate     DateTime?  @map("start_date")
  endDate       DateTime?  @map("end_date")
  businessId    Int        @map("business_id")
  createdBy     Int?       @map("created_by")
  updatedBy     Int?       @map("updated_by")
  createdAt     DateTime   @default(now()) @map("created_at")
  updatedAt     DateTime   @updatedAt @map("updated_at")
  courses       Course[]
  business      Business   @relation(fields: [businessId], references: [id], onDelete: Cascade)
  createdByUser User?      @relation("CreatedExams", fields: [createdBy], references: [id], onDelete: Cascade)
  updatedByUser User?      @relation("UpdatedExams", fields: [updatedBy], references: [id], onDelete: Cascade)

  @@unique([businessId, name])
  @@index([businessId])
  @@index([businessId, status])
  @@map("exams")
}

model Course {
  id          Int          @id @default(autoincrement())
  name        String
  description String?
  startDate   DateTime?    @map("start_date")
  endDate     DateTime?    @map("end_date")
  status      CourseStatus @default(ACTIVE)
  examId      Int          @map("exam_id")
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")
  batches     Batch[]
  exam        Exam         @relation(fields: [examId], references: [id], onDelete: Cascade)
  subjects    Subject[]

  @@unique([examId, name])
  @@index([examId])
  @@map("courses")
}

model Subject {
  id          Int           @id @default(autoincrement())
  name        String
  description String?
  status      SubjectStatus @default(ACTIVE)
  courseId    Int           @map("course_id")
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")
  course      Course        @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([courseId, name])
  @@index([courseId])
  @@map("subjects")
}

model Permission {
  id              Int              @id @default(autoincrement())
  code            String           @unique
  description     String?
  createdAt       DateTime         @default(now()) @map("created_at")
  updatedAt       DateTime         @updatedAt @map("updated_at")
  rolePermissions RolePermission[]

  @@map("permissions")
}

model RolePermission {
  id           Int        @id @default(autoincrement())
  userId       Int        @map("user_id")
  permissionId Int        @map("permission_id")
  isDeleted    Boolean    @default(false) @map("is_deleted")
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, permissionId])
  @@map("role_permissions")
}

enum UserRole {
  SUPERADMIN
  ADMIN
  TEACHER
  STUDENT
  USER
}

enum UserStatus {
  ACTIVE
  INACTIVE
}

enum ExamStatus {
  ACTIVE
  INACTIVE
}

enum CourseStatus {
  ACTIVE
  INACTIVE
}

enum SubjectStatus {
  ACTIVE
  INACTIVE
}

enum ContentType {
  PDF
  IMAGE
}

enum ContentStatus {
  ACTIVE
  INACTIVE
}

model Content {
  id         Int           @id @default(autoincrement())
  batchId    Int           @map("batch_id")
  title      String
  type       ContentType
  filePath   String        @map("file_path")
  fileSize   Int           @map("file_size") // in bytes
  status     ContentStatus @default(ACTIVE)
  uploadedBy Int           @map("uploaded_by")
  updatedBy  Int?          @map("updated_by")
  createdAt  DateTime      @default(now()) @map("created_at")
  updatedAt  DateTime      @updatedAt @map("updated_at")

  // Relations
  batch    Batch @relation(fields: [batchId], references: [id], onDelete: Cascade)
  uploader User  @relation("ContentUploader", fields: [uploadedBy], references: [id], onDelete: Cascade)
  updater  User? @relation("ContentUpdater", fields: [updatedBy], references: [id], onDelete: Cascade)

  @@index([batchId])
  @@index([batchId, status])
  @@index([uploadedBy])
  @@map("contents")
}

enum TeacherStatus {
  ACTIVE
  INACTIVE
}

enum Gender {
  male
  female
  other
}

model Teacher {
  id               Int           @id @default(autoincrement())
  userId           Int           @unique @map("user_id")
  businessId       Int           @map("business_id")
  qualification    String
  experienceYears  Int           @map("experience_years")
  designation      String
  bio              String?
  languages        String[]      @default([])
  gender           Gender?
  dob              DateTime?     @map("date_of_birth")
  address          String?
  status           TeacherStatus @default(ACTIVE)
  createdBy        Int?          @map("created_by")
  updatedBy        Int?          @map("updated_by")
  createdAt        DateTime      @default(now()) @map("created_at")
  updatedAt        DateTime      @updatedAt @map("updated_at")

  // Relations
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  business  Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  createdByUser User? @relation("TeacherCreatedBy", fields: [createdBy], references: [id], onDelete: SetNull)
  updatedByUser User? @relation("TeacherUpdatedBy", fields: [updatedBy], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([businessId])
  @@index([status])
  @@map("teachers")
}

model ApiAuditLog {
  id             Int      @id @default(autoincrement())
  userId         Int?     @map("user_id")
  role           String?
  httpMethod     String   @map("http_method")
  requestUrl     String   @map("request_url")
  requestPath    String   @map("request_path")
  queryParams    Json?    @map("query_params")
  requestBody    Json?    @map("request_body")
  responseStatus Int      @map("response_status")
  responseTimeMs Int      @map("response_time_ms")
  responseBody   Json?    @map("response_body")
  errorCode      String?  @map("error_code")
  errorMessage   String?  @map("error_message")
  createdAt      DateTime @default(now()) @map("created_at")

  @@map("api_audit_logs")
}
